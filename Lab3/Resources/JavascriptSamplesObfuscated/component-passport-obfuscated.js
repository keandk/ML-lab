var _0x8dc7=['deserializeUser','catch','setupModels','user','userIdentity','models','init','map','useCustomCallback','configureProvider','redirect','returnTo','/welcome','parse','search','/signin','auth0','flash','success','email','info','login','redirectWithFlash','prototype','app','middleware','session:after','initialize','session'];(function(_0x285aa4,_0x406f2b){var _0xb5e612=function(_0x1ba72a){while(--_0x1ba72a){_0x285aa4['push'](_0x285aa4['shift']());}};_0xb5e612(++_0x406f2b);}(_0x8dc7,0x1ca));var _0x2b09=function(_0x2d8f05,_0x4b81bb){_0x2d8f05=_0x2d8f05-0x0;var _0x4d74cb=_0x8dc7[_0x2d8f05];return _0x4d74cb;};import _0x2c38fd from'passport';import{PassportConfigurator}from'@freecodecamp/loopback-component-passport';import _0x59b8c8 from'url';import _0x4ce3e8 from'dedent';import{getUserById}from'./utils/user-stats';import{homeLocation}from'../../config/env';import _0x47fe3c from'./passport-providers';import{setAccessTokenToResponse}from'./utils/getSetAccessToken';const passportOptions={'emailOptional':!![],'profileToUser':null};PassportConfigurator[_0x2b09('0x0')]['init']=function passportInit(noSession){this[_0x2b09('0x1')][_0x2b09('0x2')](_0x2b09('0x3'),_0x2c38fd[_0x2b09('0x4')]());if(noSession){return;}this['app'][_0x2b09('0x2')]('session:after',_0x2c38fd[_0x2b09('0x5')]());_0x2c38fd['serializeUser']((user,done)=>done(null,user['id']));_0x2c38fd[_0x2b09('0x6')](async(id,done)=>{const user=await getUserById(id)[_0x2b09('0x7')](done);return done(null,user);});};export function setupPassport(app){const configurator=new PassportConfigurator(app);configurator[_0x2b09('0x8')]({'userModel':app['models'][_0x2b09('0x9')],'userIdentityModel':app['models'][_0x2b09('0xa')],'userCredentialModel':app[_0x2b09('0xb')]['userCredential']});configurator[_0x2b09('0xc')]();Object['keys'](_0x47fe3c)[_0x2b09('0xd')](function(strategy){let config=_0x47fe3c[strategy];config[_0x2b09('0x5')]=config[_0x2b09('0x5')]!==![];config['customCallback']=!config[_0x2b09('0xe')]?null:createPassportCallbackAuthenticator(strategy,config);configurator[_0x2b09('0xf')](strategy,{...config,...passportOptions});});}export const saveResponseAuthCookies=()=>{return(req,res,next)=>{const user=req[_0x2b09('0x9')];if(!user){return res[_0x2b09('0x10')]('/signin');}const {accessToken}=user;setAccessTokenToResponse({'accessToken':accessToken},req,res);return next();};};export const loginRedirect=()=>{return(req,res)=>{const successRedirect=req=>{if(!!req&&req[_0x2b09('0x5')]&&req[_0x2b09('0x5')]['returnTo']){delete req['session'][_0x2b09('0x11')];return homeLocation+_0x2b09('0x12');}return homeLocation+_0x2b09('0x12');};let redirect=_0x59b8c8[_0x2b09('0x13')](successRedirect(req),!![]);delete redirect[_0x2b09('0x14')];redirect=_0x59b8c8['format'](redirect);return res[_0x2b09('0x10')](redirect);};};export const createPassportCallbackAuthenticator=(strategy,config)=>(req,res,next)=>{return _0x2c38fd['authenticate'](strategy,{'session':![]},(err,user,userInfo)=>{if(err){return next(err);}if(!user||!userInfo){return res['redirect'](_0x2b09('0x15'));}const redirect=homeLocation+'/welcome';const {accessToken}=userInfo;const {provider}=config;if(accessToken&&accessToken['id']){if(provider===_0x2b09('0x16')){req[_0x2b09('0x17')](_0x2b09('0x18'),_0x4ce3e8`
              Success! You have signed in to your account. Happy Coding!
            `);}else if(user[_0x2b09('0x19')]){req[_0x2b09('0x17')](_0x2b09('0x1a'),_0x4ce3e8`
We are moving away from social authentication for privacy reasons. Next time
we recommend using your email address: ${user[_0x2b09('0x19')]} to sign in instead.
            `);}setAccessTokenToResponse({'accessToken':accessToken},req,res);req[_0x2b09('0x1b')](user);}return res[_0x2b09('0x1c')](redirect);})(req,res,next);};